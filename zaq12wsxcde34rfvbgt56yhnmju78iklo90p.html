<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Rilis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Mengatur font dasar dan latar belakang utama menjadi putih */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Latar belakang diubah menjadi putih */
        }
        /* Styling dan transisi untuk semua input form */
        .form-input {
            transition: all 0.2s ease-in-out;
        }
        /* Efek shadow dan border saat input form aktif (di-klik) */
        .form-input:focus {
            border-color: #0973D6;
            box-shadow: 0 0 0 3px rgba(9, 115, 214, 0.2);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Kontainer utama dengan padding responsif -->
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <!-- ===== HEADER HALAMAN ===== -->
        <header class="mb-12 text-center">
            <!-- Ukuran font judul dibuat responsif (lg, base) -->
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Buat Rilis</h1>
			  </header>

        <!-- ===== FORM UTAMA ===== -->
        <!-- Diberi jarak antar fieldset dengan `space-y-10` -->
        <form id="rilis-form" class="space-y-10">
            
            <!-- Konfigurasi GitHub -->
            <fieldset>
                <!-- Judul bagian tanpa garis bawah -->
                <legend class="text-xl font-semibold text-gray-800 mb-4">Konfigurasi</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="github-token" class="block text-sm font-medium text-gray-700 mb-1">Kode</label>
                        <input type="password" id="github-token" class="form-input w-full p-2.5 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" placeholder="Tempel token Anda di sini" required>
                    </div>
                    <div>
                        <label for="github-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="github-username" class="form-input w-full p-2.5 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" placeholder="Contoh: pmiibalinusra" required>
                    </div>
                    <div>
                        <label for="repo-name" class="block text-sm font-medium text-gray-700 mb-1">Repo</label>
                        <input type="text" id="repo-name" class="form-input w-full p-2.5 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" placeholder="Contoh: pmiibalinusra.or.id" required>
                    </div>
                    <div>
                        <label for="commit-message" class="block text-sm font-medium text-gray-700 mb-1">Commit</label>
                        <input type="text" id="commit-message" class="form-input w-full p-2.5 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" value="Rilis baru via form">
                    </div>
                </div>
            </fieldset>

            <!-- 2. Metadata Rilis -->
            <fieldset>
                <!-- Judul bagian tanpa garis bawah -->
                <legend class="text-xl font-semibold text-gray-800 mb-4">Metadata</legend>
                <div class="space-y-6">
                    <div>
                        <label for="rilis-title" class="block text-sm font-medium text-gray-700 mb-1">Judul</label>
                        <input type="text" id="rilis-title" class="form-input w-full p-2.5 text-lg border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-base" placeholder="Judul yang menarik dan informatif" required>
                    </div>
                     <div>
                        <label for="rilis-author" class="block text-sm font-medium text-gray-700 mb-1">Author</label>
                        <input type="text" id="rilis-author" class="form-input w-full p-2.5 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" placeholder="Nama penulis atau tim" required>
                    </div>
                     <div>
                        <label for="rilis-image" class="block text-sm font-medium text-gray-700 mb-1">Gambar</label>
                        <input type="file" id="rilis-image" class="form-input w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/png, image/jpeg, image/webp">
                        <p id="file-size-error" class="text-red-500 text-xs mt-1 hidden">Ukuran file terlalu besar! Maksimal 1 MB.</p>
                    </div>
                     <div>
                        <label for="rilis-caption" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <input type="text" id="rilis-caption" class="form-input w-full p-2.5 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" placeholder="Deskripsi singkat untuk gambar di atas">
                    </div>
                </div>
            </fieldset>

            <!-- 3. Isi Konten -->
            <fieldset>
                 <!-- Judul bagian tanpa garis bawah -->
                 <legend class="text-xl font-semibold text-gray-800 mb-4">Konten</legend>
                 <div>
                    <textarea id="rilis-content" rows="15" class="form-input w-full p-3 text-base border border-gray-300 rounded-md placeholder:text-gray-400 placeholder:text-sm" placeholder="Tulis konten rilis di sini. Anda bisa menggunakan format Markdown seperti **tebal**, *miring*, dan > kutipan." required></textarea>
                 </div>
            </fieldset>

            <!-- Tombol Submit -->
            <div class="pt-4">
                <button type="submit" id="submit-button" class="w-full bg-[#0973D6] text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-3 hover:bg-[#2918A9] transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="button-text" class="text-base">Publikasi</span>
                    <div id="button-loader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>
        </form>

        <!-- Status Log -->
        <div id="status-container" class="mt-8 hidden">
             <h3 class="text-base sm:text-lg font-semibold text-gray-700">Status</h3>
             <pre id="status-log" class="bg-gray-900 text-white text-xs rounded-md p-4 mt-2 overflow-x-auto"></pre>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // === INISIALISASI ELEMEN DOM ===
        const form = document.getElementById('rilis-form');
        const imageInput = document.getElementById('rilis-image');
        const fileSizeError = document.getElementById('file-size-error');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        const statusContainer = document.getElementById('status-container');
        const statusLog = document.getElementById('status-log');

        // === EVENT LISTENER UNTUK VALIDASI UKURAN GAMBAR ===
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const isTooLarge = file.size > 1 * 1024 * 1024; // 1 MB
                fileSizeError.classList.toggle('hidden', !isTooLarge);
                submitButton.disabled = isTooLarge;
                if(isTooLarge) {
                    this.value = ''; // Reset input jika file terlalu besar
                }
            }
        });

        // === FUNGSI HELPER ===

        // Menampilkan pesan status di log box
        function logStatus(message, isError = false) {
            statusContainer.classList.remove('hidden');
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.className = isError ? 'text-red-400' : 'text-green-400';
            statusLog.appendChild(logEntry);
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll ke bawah
        }

        // Mengubah string menjadi format "slug" (untuk nama file)
        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Ganti spasi dengan -
                .replace(/[^\w\-]+/g, '')       // Hapus karakter non-alfanumerik
                .replace(/\-\-+/g, '-')         // Ganti -- dengan -
                .replace(/^-+/, '')             // Hapus - di awal
                .replace(/-+$/, '');            // Hapus - di akhir
        }

        // Mengubah file menjadi string Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    resolve(reader.result.split(',')[1]); // Ambil hanya data base64
                };
                reader.onerror = error => reject(error);
            });
        }

        // === EVENT LISTENER UTAMA UNTUK SUBMIT FORM ===
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Mencegah form mengirim data secara tradisional

            // Mengambil semua nilai dari input form
            const githubToken = document.getElementById('github-token').value.trim();
            const owner = document.getElementById('github-username').value.trim();
            const repo = document.getElementById('repo-name').value.trim();
            const title = document.getElementById('rilis-title').value.trim();
            const author = document.getElementById('rilis-author').value.trim();
            const imageFile = imageInput.files[0];
            const imageCaption = document.getElementById('rilis-caption').value.trim();
            const contentBody = document.getElementById('rilis-content').value.trim();
            const commitMessage = document.getElementById('commit-message').value.trim();

            // Validasi input dasar
            if (!githubToken || !owner || !repo || !title || !contentBody) {
                logStatus('Error: Mohon isi semua kolom yang wajib diisi (Token, Username, Repo, Judul, Isi).', true);
                return;
            }

            // Mengubah tampilan tombol menjadi mode loading
            buttonText.textContent = 'Memproses...';
            buttonLoader.classList.remove('hidden');
            submitButton.disabled = true;
            statusLog.innerHTML = ''; // Bersihkan log sebelumnya

            try {
                let finalImageUrl = '';
                const slug = slugify(title);

                // --- Langkah 1: Upload Gambar (jika ada) ---
                if (imageFile) {
                    logStatus('Mempersiapkan gambar untuk diunggah...');
                    const imageBase64 = await getBase64(imageFile);
                    const imageExtension = imageFile.name.split('.').pop();
                    const imageFileName = `${slug}.${imageExtension}`;
                    const imagePath = `assets/rilis/${imageFileName}`;
                    const imageUrlApi = `https://api.github.com/repos/${owner}/${repo}/contents/${imagePath}`;

                    logStatus(`Mengunggah gambar ke: ${imagePath}`);
                    const imageResponse = await fetch(imageUrlApi, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Upload gambar: ${imageFileName}`,
                            content: imageBase64
                        })
                    });

                    const imageResult = await imageResponse.json();
                    if (!imageResponse.ok) {
                        throw new Error(`Gagal mengunggah gambar: ${imageResult.message}`);
                    }
                    finalImageUrl = imageResult.content.download_url;
                    logStatus(`Gambar berhasil diunggah!`, false);
                }

                // --- Langkah 2: Membuat file Markdown ---
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const postFileName = `${year}-${month}-${day}-${slug}.md`;
                const postFilePath = `_posts/${postFileName}`;
                
                logStatus(`Membuat file rilis: ${postFilePath}`);

                // Membuat konten Front Matter untuk file .md
                const fullDate = `${year}-${month}-${day} ${now.toLocaleTimeString('en-GB', { hour12: false })}`;
                const frontMatter = `---
layout: post
title: "${title.replace(/"/g, '\\"')}"
date: ${fullDate} +0800
author: "${author.replace(/"/g, '\\"')}"
image: "${finalImageUrl}"
image_caption: "${imageCaption.replace(/"/g, '\\"')}"
---

`;
                // Menggabungkan front matter dengan isi konten
                const markdownContent = frontMatter + contentBody;
                // Encode konten ke Base64 dengan penanganan karakter UTF-8
                const encodedContent = btoa(unescape(encodeURIComponent(markdownContent)));
                
                // --- Langkah 3: Mengirim file Markdown ke GitHub ---
                const postUrlApi = `https://api.github.com/repos/${owner}/${repo}/contents/${postFilePath}`;
                logStatus(`Mengirim rilis ke GitHub...`);

                const postResponse = await fetch(postUrlApi, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: encodedContent
                    })
                });

                const postResult = await postResponse.json();
                if (!postResponse.ok) {
                    throw new Error(`Gagal mempublikasikan rilis: ${postResult.message}`);
                }
                
                logStatus('SUKSES! Rilis berhasil dipublikasikan.', false);
                logStatus(`Lihat commit di GitHub: ${postResult.commit.html_url}`, false);
                form.reset(); // Mengosongkan form setelah berhasil

            } catch (error) {
                logStatus(`Error: ${error.message}`, true);
            } finally {
                // Mengembalikan tampilan tombol ke kondisi normal
                buttonText.textContent = 'Publikasikan Rilis';
                buttonLoader.classList.add('hidden');
                submitButton.disabled = false;
            }
        });
    });
    </script>
</body>
</html>
